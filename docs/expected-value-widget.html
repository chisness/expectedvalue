<div id="expectedValueWidget">
    <h3>What is the expected value of this website?</h3>
    <p id="entryCount">Entries so far: 0</p>
    <div id="inputSection">
        <input type="text" id="valueInput" placeholder="Enter value">
        <button id="submitBtn">Submit</button>
    </div>
    <div id="thankYouMessage" style="display: none;">
        <p>Thank you and have a nice day! Stats loading...</p>
    </div>
    <div id="statsSection" style="display: none;">
        <p>Median value: <span id="medianValue">No data yet</span></p>
        <p>Average value: <span id="averageValue">No data yet</span></p>
    </div>
</div>

<script>
let currentEntryCount = 0;

function fetchEntryCount() {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycby71JogbnFqhM9rUs1b9uSMzK5zB-YrbFmZ2Ut47OUsPvWXhWp60slmpAggRDOWp-JQ/exec';

    return fetch(url)
        .then(response => response.json())
        .then(count => {
            currentEntryCount = count;
            document.getElementById('entryCount').textContent = `Entries so far: ${count}`;
            return count;
        })
        .catch(error => {
            console.error('Error fetching entry count:', error);
            throw error;
        });
}

function sendToGoogleSheets(value) {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycby71JogbnFqhM9rUs1b9uSMzK5zB-YrbFmZ2Ut47OUsPvWXhWp60slmpAggRDOWp-JQ/exec';

    return fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json',
        },
        redirect: 'follow',
        body: JSON.stringify({value: value, timestamp: new Date().toISOString()})
    })
    .then(response => {
        console.log('Success:', response);
        return value;
    })
    .catch(error => {
        console.error('Error:', error);
        throw error;
    });
}

function fetchAllSubmissions(newSubmission) {
    console.log('Fetching submissions...');
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycby71JogbnFqhM9rUs1b9uSMzK5zB-YrbFmZ2Ut47OUsPvWXhWp60slmpAggRDOWp-JQ/exec';

    return fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Data parsed:', data);
            let allSubmissions = data && data.length > 0 ? data.map(row => parseFloat(row[0])) : [];
            // Include the new submission
            allSubmissions.push(newSubmission);
            console.log('All submissions:', allSubmissions);
            return allSubmissions;
        })
        .catch(error => {
            console.error('Error fetching submissions:', error);
            throw error;
        });
}

function updateStats(submissions) {
    console.log('Updating stats...');
    const statsSection = document.getElementById('statsSection');
    const medianValueSpan = document.getElementById('medianValue');
    const averageValueSpan = document.getElementById('averageValue');

    if (submissions.length === 0) {
        console.log('No submissions to display');
        medianValueSpan.textContent = 'No data yet';
        averageValueSpan.textContent = 'No data yet';
    } else {
        const sortedSubmissions = submissions.slice().sort((a, b) => a - b);
        const len = sortedSubmissions.length;

        // Calculate median
        const median = len % 2 === 0
            ? (sortedSubmissions[len / 2 - 1] + sortedSubmissions[len / 2]) / 2
            : sortedSubmissions[Math.floor(len / 2)];

        // Calculate average
        const average = submissions.reduce((a, b) => a + b, 0) / len;

        console.log('Median:', median, 'Average:', average);
        medianValueSpan.textContent = median.toFixed(2);
        averageValueSpan.textContent = average.toFixed(2);
    }

    statsSection.style.display = 'block';
}

// Fetch entry count when the page loads
document.addEventListener('DOMContentLoaded', fetchEntryCount);

// Update the submit button event listener
document.getElementById('submitBtn').addEventListener('click', function() {
    const valueInput = document.getElementById('valueInput');
    const inputValue = valueInput.value.replace(/,/g, '');
    const value = parseFloat(inputValue);
    if (isNaN(value) || value < 0 || value > 1e6) { 
        alert('Please enter a valid number between 0 and 1m');
        return;
    }
    
    console.log('Submitting value:', value);
    fetchEntryCount()
        .then(() => sendToGoogleSheets(value))
        .then(submittedValue => {
            // Update entry count display
            currentEntryCount++;
            document.getElementById('entryCount').textContent = `Entries so far: ${currentEntryCount}`;
            
            // Disable input and show thank you message
            document.getElementById('inputSection').style.display = 'none';
            document.getElementById('thankYouMessage').style.display = 'block';

            console.log('Fetching all submissions...');
            return fetchAllSubmissions(submittedValue);
        })
        .then(updateStats)
        .catch(error => {
            console.error('Error in submission process:', error);
        });
});
</script>