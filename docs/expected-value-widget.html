<div id="expectedValueWidget">
    <h3>What is the expected value of this website?</h3>
    <div id="inputSection">
        <input type="text" id="valueInput" placeholder="Enter value">
        <button id="submitBtn">Submit</button>
    </div>
    <div id="thankYouMessage" style="display: none;">
        <p>Thank you and have a nice day!</p>
    </div>
    <div id="statsSection" style="display: none;">
        <p>Median value: <span id="medianValue"></span></p>
        <p>Average value: <span id="averageValue"></span></p>
        <p>Last submission: <span id="lastSubmission"></span></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// console.log('Chart.js loaded:', !!window.Chart);

let allSubmissions = [];
let myChart;

document.addEventListener('DOMContentLoaded', function() {
    const valueInput = document.getElementById('valueInput');
    const submitBtn = document.getElementById('submitBtn');
    const inputSection = document.getElementById('inputSection');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const chartSection = document.getElementById('chartSection');

    submitBtn.addEventListener('click', function() {
    const inputValue = valueInput.value.replace(/,/g, '');
    const value = parseFloat(inputValue);
    if (isNaN(value) || value < 0 || value > 1e12) { // 1e12 is one trillion
        alert('Please enter a valid number between 0 and 1,000,000,000,000');
        return;
    }
    
    console.log('Submitting value:', value);
    sendToGoogleSheets(value);

    // Disable input and show thank you message
    inputSection.style.display = 'none';
    thankYouMessage.style.display = 'block';

    console.log('Fetching all submissions...');
    fetchAllSubmissions();
    }); 
    
    console.log('Submitting value:', value);
    sendToGoogleSheets(value);

    // Disable input and show thank you message
    inputSection.style.display = 'none';
    thankYouMessage.style.display = 'block';

    console.log('Fetching all submissions...');
    fetchAllSubmissions();
    });

function sendToGoogleSheets(value) {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json',
        },
        redirect: 'follow',
        body: JSON.stringify({value: value, timestamp: new Date().toISOString()})
    })
    .then(response => console.log('Success:', response))
    .catch(error => console.error('Error:', error));
}

function fetchAllSubmissions() {
    console.log('Fetching submissions...');
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Data parsed:', data);
            allSubmissions = data.map(row => parseFloat(row[0]));
            console.log('Parsed submissions:', allSubmissions);
            updateStats();
        })
        .catch(error => {
            console.error('Error fetching submissions:', error);
        });
}

function updateStats() {
    console.log('Updating stats...');
    const statsSection = document.getElementById('statsSection');
    const medianValueSpan = document.getElementById('medianValue');
    const averageValueSpan = document.getElementById('averageValue');
    const lastSubmissionSpan = document.getElementById('lastSubmission');

    if (allSubmissions.length === 0) {
        console.log('No submissions to display');
        return;
    }

    const sortedSubmissions = allSubmissions.slice().sort((a, b) => a - b);
    const len = sortedSubmissions.length;

    // Calculate median
    const median = len % 2 === 0
        ? (sortedSubmissions[len / 2 - 1] + sortedSubmissions[len / 2]) / 2
        : sortedSubmissions[Math.floor(len / 2)];

    // Calculate average
    const average = sortedSubmissions.reduce((a, b) => a + b, 0) / len;

    // Get last submission
    const lastSubmission = allSubmissions[allSubmissions.length - 1];

    console.log('Median:', median, 'Average:', average, 'Last Submission:', lastSubmission);
    medianValueSpan.textContent = median.toFixed(2);
    averageValueSpan.textContent = average.toFixed(2);
    lastSubmissionSpan.textContent = lastSubmission.toFixed(2);

    statsSection.style.display = 'block';
}
</script>