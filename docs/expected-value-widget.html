<div id="expectedValueWidget">
    <h3>What is the expected value of this website?</h3>
    <div id="inputSection">
        <input type="number" id="valueInput" min="0" step="0.01" placeholder="Enter value">
        <button id="submitBtn">Submit</button>
    </div>
    <div id="thankYouMessage" style="display: none;">
        <p>Thank you for your submission!</p>
    </div>
    <div id="chartSection" style="display: none;">
        <canvas id="submissionsChart"></canvas>
        <p>Median value: <span id="medianValue"></span></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
console.log('Chart.js loaded:', !!window.Chart);

let allSubmissions = [];

document.addEventListener('DOMContentLoaded', function() {
    const valueInput = document.getElementById('valueInput');
    const submitBtn = document.getElementById('submitBtn');
    const inputSection = document.getElementById('inputSection');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const chartSection = document.getElementById('chartSection');

    submitBtn.addEventListener('click', function() {
        const value = parseFloat(valueInput.value);
        if (isNaN(value) || value < 0) {
            alert('Please enter a valid positive number');
            return;
        }
        
        console.log('Submitting value:', value);
        sendToGoogleSheets(value);

        // Disable input and show thank you message
        inputSection.style.display = 'none';
        thankYouMessage.style.display = 'block';

        console.log('Fetching all submissions...');
        fetchAllSubmissions();
    });
});

function sendToGoogleSheets(value) {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json',
        },
        redirect: 'follow',
        body: JSON.stringify({value: value, timestamp: new Date().toISOString()})
    })
    .then(response => console.log('Success:', response))
    .catch(error => console.error('Error:', error));
}

function fetchAllSubmissions() {
    console.log('Fetching submissions...');
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url)
        .then(response => {
            console.log('Response received:', response);
            return response.json();
        })
        .then(data => {
            console.log('Data parsed:', data);
            allSubmissions = data.map(row => parseFloat(row[0]));
            console.log('Parsed submissions:', allSubmissions);
            updateChart();
        })
        .catch(error => {
            console.error('Error fetching submissions:', error);
        });
}

function updateChart() {
    console.log('Updating chart...');
    const chartSection = document.getElementById('chartSection');
    const medianValueSpan = document.getElementById('medianValue');
    const ctx = document.getElementById('submissionsChart').getContext('2d');

    if (allSubmissions.length === 0) {
        console.log('No submissions to chart');
        return;
    }

    // Calculate median
    const sortedSubmissions = [...allSubmissions].sort((a, b) => a - b);
    const median = sortedSubmissions.length % 2 === 0
        ? (sortedSubmissions[sortedSubmissions.length / 2 - 1] + sortedSubmissions[sortedSubmissions.length / 2]) / 2
        : sortedSubmissions[Math.floor(sortedSubmissions.length / 2)];

    console.log('Calculated median:', median);
    medianValueSpan.textContent = median.toFixed(2);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: allSubmissions.map((_, index) => `Submission ${index + 1}`),
            datasets: [{
                label: 'Submissions',
                data: allSubmissions,
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    console.log('Chart updated');
    chartSection.style.display = 'block';
    console.log('Chart section display:', chartSection.style.display);
}
</script>