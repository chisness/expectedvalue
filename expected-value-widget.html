<div id="expectedValueWidget">
    <h3>What is the expected value of this website?</h3>
    <div id="inputSection">
        <input type="text" id="valueInput" placeholder="Enter value">
        <button id="submitBtn">Submit</button>
    </div>
    <div id="thankYouMessage" style="display: none;">
        <p>Thank you for your submission!</p>
    </div>
    <div id="chartSection" style="display: none;">
        <canvas id="submissionsChart"></canvas>
        <p>Median value: <span id="medianValue"></span></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
console.log('Chart.js loaded:', !!window.Chart);

let allSubmissions = [];
let myChart;

document.addEventListener('DOMContentLoaded', function() {
    const valueInput = document.getElementById('valueInput');
    const submitBtn = document.getElementById('submitBtn');
    const inputSection = document.getElementById('inputSection');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const chartSection = document.getElementById('chartSection');

    submitBtn.addEventListener('click', function() {
    const value = parseFloat(valueInput.value.replace(/,/g, ''));
    if (isNaN(value) || value < 0) {
        alert('Please enter a valid positive number');
        return;
    }
    
    console.log('Submitting value:', value);
    sendToGoogleSheets(value);

    // Disable input and show thank you message
    inputSection.style.display = 'none';
    thankYouMessage.style.display = 'block';

    console.log('Fetching all submissions...');
    fetchAllSubmissions();
    });
});

function sendToGoogleSheets(value) {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json',
        },
        redirect: 'follow',
        body: JSON.stringify({value: value, timestamp: new Date().toISOString()})
    })
    .then(response => console.log('Success:', response))
    .catch(error => console.error('Error:', error));
}

function fetchAllSubmissions() {
    console.log('Fetching submissions...');
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url)
        .then(response => {
            console.log('Response received:', response);
            return response.json();
        })
        .then(data => {
            console.log('Data parsed:', data);
            allSubmissions = data.map(row => parseFloat(row[0]));
            console.log('Parsed submissions:', allSubmissions);
            updateChart();
        })
        .catch(error => {
            console.error('Error fetching submissions:', error);
        });
}

function updateChart() {
    console.log('Updating chart...');
    const chartSection = document.getElementById('chartSection');
    const medianValueSpan = document.getElementById('medianValue');
    const ctx = document.getElementById('submissionsChart');

    if (allSubmissions.length === 0) {
        console.log('No submissions to chart');
        return;
    }

    // Calculate median
    const sortedSubmissions = allSubmissions.slice().sort((a, b) => a - b);
    const median = sortedSubmissions.length % 2 === 0
        ? (sortedSubmissions[sortedSubmissions.length / 2 - 1] + sortedSubmissions[sortedSubmissions.length / 2]) / 2
        : sortedSubmissions[Math.floor(sortedSubmissions.length / 2)];

    console.log('Calculated median:', median);
    medianValueSpan.textContent = median.toFixed(2);

    // Create histogram data
    const binCount = 10;
    const min = Math.min(...allSubmissions);
    const max = Math.max(...allSubmissions);
    const binSize = (max - min) / binCount;
    const bins = Array(binCount).fill(0);

    allSubmissions.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
        bins[binIndex]++;
    });

    const labels = bins.map((_, index) => {
        const start = (min + index * binSize).toFixed(2);
        const end = (min + (index + 1) * binSize).toFixed(2);
        return `${start} - ${end}`;
    });

    if (window.myChart instanceof Chart) {
        window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Submissions',
                data: bins,
                backgroundColor: 'rgba(75, 192, 192, 0.6)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Submissions'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Value Ranges'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Distribution of Submissions'
                }
            }
        }
    });

    console.log('Chart updated');
    chartSection.style.display = 'block';
    console.log('Chart section display:', chartSection.style.display);
}
</script>