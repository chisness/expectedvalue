<div id="expectedValueWidget">
    <h3>What is the expected value of this website?</h3>
    <div id="inputSection">
        <input type="text" id="valueInput" placeholder="Enter value">
        <button id="submitBtn">Submit</button>
    </div>
    <div id="thankYouMessage" style="display: none;">
        <p>Thank you for your submission!</p>
    </div>
    <div id="chartSection" style="display: none;">
        <canvas id="submissionsChart"></canvas>
        <p>Median value: <span id="medianValue"></span></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.0.0/build/Chart.BoxPlot.min.js"></script>
<script>
console.log('Chart.js loaded:', !!window.Chart);

let allSubmissions = [];
let myChart;

document.addEventListener('DOMContentLoaded', function() {
    const valueInput = document.getElementById('valueInput');
    const submitBtn = document.getElementById('submitBtn');
    const inputSection = document.getElementById('inputSection');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const chartSection = document.getElementById('chartSection');

    submitBtn.addEventListener('click', function() {
    const value = parseFloat(valueInput.value.replace(/,/g, ''));
    if (isNaN(value) || value < 0 || value > 1e6) { 
        alert('Please enter a valid number between 0 and 1,000,000');
        return;
    }
    
    console.log('Submitting value:', value);
    sendToGoogleSheets(value);

    // Disable input and show thank you message
    inputSection.style.display = 'none';
    thankYouMessage.style.display = 'block';

    console.log('Fetching all submissions...');
    fetchAllSubmissions();
    });
    
    console.log('Submitting value:', value);
    sendToGoogleSheets(value);

    // Disable input and show thank you message
    inputSection.style.display = 'none';
    thankYouMessage.style.display = 'block';

    console.log('Fetching all submissions...');
    fetchAllSubmissions();
    });

function sendToGoogleSheets(value) {
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url, {
        method: 'POST',
        mode: 'no-cors',
        cache: 'no-cache',
        headers: {
            'Content-Type': 'application/json',
        },
        redirect: 'follow',
        body: JSON.stringify({value: value, timestamp: new Date().toISOString()})
    })
    .then(response => console.log('Success:', response))
    .catch(error => console.error('Error:', error));
}

function fetchAllSubmissions() {
    console.log('Fetching submissions...');
    // Replace with your Google Apps Script Web App URL
    const url = 'https://script.google.com/macros/s/AKfycbyL8bvTVKKpaP47li6bbYixwt8SMklECwF4VPnsWzufb_zAi7jZ5MBMxgLUxDta0vo9/exec';

    fetch(url)
        .then(response => {
            console.log('Response received:', response);
            return response.json();
        })
        .then(data => {
            console.log('Data parsed:', data);
            allSubmissions = data.map(row => parseFloat(row[0]));
            console.log('Parsed submissions:', allSubmissions);
            updateChart();
        })
        .catch(error => {
            console.error('Error fetching submissions:', error);
        });
}

function updateChart() {
    console.log('Updating chart...');
    const chartSection = document.getElementById('chartSection');
    const medianValueSpan = document.getElementById('medianValue');
    const ctx = document.getElementById('submissionsChart');

    if (allSubmissions.length === 0) {
        console.log('No submissions to chart');
        return;
    }

    const sortedSubmissions = allSubmissions.slice().sort((a, b) => a - b);
    const len = sortedSubmissions.length;

    // Calculate quartiles
    const q1 = sortedSubmissions[Math.floor(len * 0.25)];
    const median = len % 2 === 0
        ? (sortedSubmissions[len / 2 - 1] + sortedSubmissions[len / 2]) / 2
        : sortedSubmissions[Math.floor(len / 2)];
    const q3 = sortedSubmissions[Math.floor(len * 0.75)];

    // Calculate min and max (excluding outliers)
    const iqr = q3 - q1;
    const lowerFence = Math.max(q1 - 1.5 * iqr, sortedSubmissions[0]);
    const upperFence = Math.min(q3 + 1.5 * iqr, sortedSubmissions[len - 1]);

    console.log('Box plot data:', { lowerFence, q1, median, q3, upperFence });
    medianValueSpan.textContent = median.toFixed(2);

    if (window.myChart instanceof Chart) {
        window.myChart.destroy();
    }

    window.myChart = new Chart(ctx, {
        type: 'boxplot',
        data: {
            datasets: [{
                label: 'Submissions',
                data: [{
                    min: lowerFence,
                    q1: q1,
                    median: median,
                    q3: q3,
                    max: upperFence,
                    outliers: sortedSubmissions.filter(v => v < lowerFence || v > upperFence)
                }],
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                outlierBackgroundColor: 'rgba(255, 99, 132, 0.6)',
                outlierBorderColor: 'rgba(255, 99, 132, 1)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribution of Submissions'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Value'
                    }
                }
            }
        }
    });

    console.log('Chart updated');
    chartSection.style.display = 'block';
    console.log('Chart section display:', chartSection.style.display);
}
</script>